<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<!-- headlinks removed -->
	<link rel="shortcut icon" href="../../../../misc/uewiki-favicon.png"/>
    <title>Legacy:Bonehed316/ShadowSource - Unreal Wiki</title>
    <style type="text/css">/*<![CDATA[*/ @import "../../../../skins/offline/main.css"; /*]]>*/</style>
    <link rel="stylesheet" type="text/css" media="print" href="../../../../skins/common/commonPrint.css" />
    <!--[if lt IE 5.5000]><style type="text/css">@import "../../../../skins/monobook/IE50Fixes.css";</style><![endif]-->
    <!--[if IE 5.5000]><style type="text/css">@import "../../../../skins/monobook/IE55Fixes.css";</style><![endif]-->
    <!--[if IE 6]><style type="text/css">@import "../../../../skins/monobook/IE60Fixes.css";</style><![endif]-->
    <!--[if IE]><script type="text/javascript" src="../../../../skins/common/IEFixes.js"></script>
    <meta http-equiv="imagetoolbar" content="no" /><![endif]-->
    <script type="text/javascript" src="../../../../skins/common/wikibits.js"></script>
    <script type="text/javascript" src="../../../../skins/offline/md5.js"></script>
    <script type="text/javascript" src="../../../../skins/offline/utf8.js"></script>
    <script type="text/javascript" src="../../../../skins/offline/lookup.js"></script>
    <script type="text/javascript" src="../../../../articles/-/_/_/-.html"></script>        <style type="text/css">/*<![CDATA[*/
@import "../../../../articles/c/o/m/MediaWiki%7ECommon.css_d42e.html";
@import "../../../../articles/m/o/n/MediaWiki%7EMonobook.css_fb19.html";
@import "../../../../articles/-/_/_/-.html";
/*]]>*/</style>          </head>
  <body
    class="ns-100">
    <div id="globalWrapper">
      <div id="column-content">
	<div id="content">
	  <a name="top" id="contentTop"></a>
	        <h1 class="firstHeading">Legacy:Bonehed316/ShadowSource</h1>
	  <div id="bodyContent">
	    <h3 id="siteSub">From Unreal Wiki, The Unreal Engine Documentation Site</h3>
	    <div id="contentSub"><span class="subpages">&lt; <a href="../../../../articles/b/o/n/Legacy%7EBonehed316_f1d6.html" title="Legacy:Bonehed316">Legacy:Bonehed316</a></span></div>
	    	    	    <!-- start content -->
	    <p>As many others have done, I have created some form of shadows using projectors. There are other methods, including SquirrelZero's <a href="../../../../articles/s/q/u/Legacy%7ESquirrelZero_RealtimeShadows_8cd2.html" title="Legacy:SquirrelZero/RealtimeShadows">RealtimeShadows</a>, which are good indeed, but the workload is per pawn, and performed each tick, and therefor is, and will always be, very slow.</p>
<p>Next there is a method, which is very similar to my own, called <a href="../../../../articles/s/o/u/Legacy%7ESourced_Player_Shadows_7389.html" title="Legacy:Sourced Player Shadows">Sourced_Player_Shadows</a>. There are also some others, but I cant find the links right off hand, and I'm sure there are some which I've never thought of myself. I am not familiar with other methods, so I will not comment on them, nor compare directly with any of them.</p>
<p>The method I worked on, which is by no means a superb solution, is to use an actor I call a ShadowSource to handle attaching and detaching shadow projectors, and also act as a "source" of the shadow itself. It uses the Touch() and UnTouch() functions to spawn and destroy shadow projectors. The projectors use a reference to the ShadowSource as a location from which the shadow should be cast. A level designer would place these ShadowSources wherever a static mesh that represents a light source exists, and the code will take care of the rest.</p>
<p>Once the idea is down, the code here is trivial:</p>
<div dir="ltr" style="text-align: left;" class="highlighted-source">
<pre class="source-uscript">
<span class="kw5">class</span> ShadowSource <span class="kw5">extends</span> <a href="/Actor"><span class="kw10">Actor</span></a>
        <span class="kw6">placeable</span>;
 
<span class="kw5">var</span> class&lt;ShadowBitmapMaterial&gt; TextureDetailClass;
<span class="kw5">var</span> array&lt;DynamicShadow&gt; Shadows;
 
<span class="kw5">var</span><span class="br0">(</span><span class="br0">)</span> <span class="kw4">enum</span> EShadowDetail        <span class="co1">// shadow detail level</span>
<span class="br0">{</span>
        SD_Low,                 <span class="co1">// 64x64</span>
        SD_Medium,              <span class="co1">// 128x128</span>
        SD_High,                <span class="co1">// 256x256</span>
        SD_Highest,             <span class="co1">// 512x512</span>
<span class="br0">}</span> ShadowDetail;
 
<span class="kw5">var</span><span class="br0">(</span><span class="br0">)</span> DynamicShadow.<span class="me1">EShadowEffect</span> ShadowEffect;             <span class="co1">// the type of light effect for this shadow</span>
<span class="kw5">var</span><span class="br0">(</span><span class="br0">)</span> <span class="kw4">int</span> MaxFOV;                                   <span class="co1">// adjusts rotation to compensate for FOV</span>
<span class="kw5">var</span><span class="br0">(</span><span class="br0">)</span> <span class="kw4">float</span> FOVScale;                                       <span class="co1">// scales FOV to change the size of the shadow</span>
<span class="kw5">var</span><span class="br0">(</span><span class="br0">)</span> <span class="kw4">int</span> MaxTraceDistance;                         <span class="co1">// how far the projector can draw</span>
<span class="kw5">var</span><span class="br0">(</span>ShadowSourceEffect<span class="br0">)</span> <span class="kw4">float</span> PhaseScale;           <span class="co1">// used to control light effects, result may vary depending on the effect used</span>
 
<span class="co1">// fire effect specific variables</span>
<span class="kw5">var</span><span class="br0">(</span>ShadowSourceEffect<span class="br0">)</span> <span class="kw4">int</span> FireFlickerMagnitude;   <span class="co1">// how far the fire flicker is allowed to move</span>
<span class="kw5">var</span><span class="br0">(</span>ShadowSourceEffect<span class="br0">)</span> <span class="kw4">int</span> FireFlickerSpeed;               <span class="co1">// how fast the shadow moves</span>
 
<span class="co1">// Initialize anything</span>
<span class="kw5">event</span> PostBeginPlay<span class="br0">(</span><span class="br0">)</span>
<span class="br0">{</span>
        GetShadowTexture<span class="br0">(</span><span class="br0">)</span>;
<span class="br0">}</span>
 
<span class="co1">// sets the shadow texture depending on the selected detail setting</span>
<span class="co1">// each class is simply a subclass of ShadowBitmapMaterial with a different USize and VSize</span>
<span class="kw5">function</span> GetShadowTexture<span class="br0">(</span><span class="br0">)</span>
<span class="br0">{</span>
        <span class="kw1">Switch</span><span class="br0">(</span>ShadowDetail<span class="br0">)</span>
        <span class="br0">{</span>
                <span class="kw1">case</span> SD_Low: TextureDetailClass = <span class="kw5">Class</span><span class="st0">'ShadowDetailLow'</span>; <span class="kw1">break</span>;
                <span class="kw1">case</span> SD_Medium: TextureDetailClass = <span class="kw5">Class</span><span class="st0">'ShadowDetailMedium'</span>;break;
                <span class="kw1">case</span> SD_High:   TextureDetailClass = <span class="kw5">Class</span><span class="st0">'ShadowDetailHigh'</span>;break;
                <span class="kw1">case</span> SD_Highest: TextureDetailClass = <span class="kw5">Class</span><span class="st0">'ShadowDetailHighest'</span>; <span class="kw1">break</span>;
                <span class="kw1">default</span>: TextureDetailClass = <span class="kw5">Class</span><span class="st0">'ShadowDetailLow'</span>; <span class="kw1">break</span>;
        <span class="br0">}</span>
<span class="br0">}</span>
 
<span class="kw5">function</span> DynamicShadow SpawnShadow<span class="br0">(</span><a href="/Pawn"><span class="kw10">Pawn</span></a> P<span class="br0">)</span>
<span class="br0">{</span>
        <span class="kw5">local</span> DynamicShadow DynamicShadow;
 
        DynamicShadow = Spawn<span class="br0">(</span><span class="kw5">class</span><span class="st0">'DynamicShadow'</span>,<span class="kw8">self</span>,,P.<span class="me1">Location</span><span class="br0">)</span>;
        <span class="kw1">if</span> <span class="br0">(</span>DynamicShadow != <span class="kw9">None</span><span class="br0">)</span>
        <span class="br0">{</span>
                DynamicShadow.<span class="me1">ShadowActor</span> = P;
                DynamicShadow.<span class="me1">Instigator</span> = P;
                DynamicShadow.<span class="me1">ShadowEffect</span> = ShadowEffect;
                DynamicShadow.<span class="me1">FireFlickerMagnitude</span> = FireFlickerMagnitude;
                DynamicShadow.<span class="me1">FireFlickerSpeed</span> = FireFlickerSpeed;
                DynamicShadow.<span class="me1">PhaseScale</span> = PhaseScale;
                DynamicShadow.<span class="me1">bBlobShadow</span> = <span class="kw9">False</span>;
                DynamicShadow.<span class="me1">FOVScale</span> = FOVScale;
                DynamicShadow.<span class="me1">MaxFOV</span> = MaxFOV;
                DynamicShadow.<span class="me1">MaxTraceDistance</span> = MaxTraceDistance;
                DynamicShadow.<span class="me1">ShadowTexture</span> = ShadowBitmapMaterial<span class="br0">(</span> <span class="kw8">Level</span>.<span class="me1">ObjectPool</span>.<span class="me1">AllocateObject</span><span class="br0">(</span>TextureDetailClass<span class="br0">)</span> <span class="br0">)</span>;
                DynamicShadow.<span class="me1">InitShadow</span><span class="br0">(</span><span class="br0">)</span>;
        <span class="br0">}</span>
        <span class="kw1">return</span> DynamicShadow;
<span class="br0">}</span>
 
<span class="co1">// pawns are given a shadow when they touch</span>
<span class="kw5">event</span> Touch<span class="br0">(</span><a href="/Actor"><span class="kw10">Actor</span></a> Other<span class="br0">)</span>
<span class="br0">{</span>
        <span class="kw1">if</span> <span class="br0">(</span><a href="/Pawn"><span class="kw10">Pawn</span></a><span class="br0">(</span>Other<span class="br0">)</span> != <span class="kw9">None</span><span class="br0">)</span>
                Shadows<span class="br0">[</span>Shadows.<span class="kw6">Length</span><span class="br0">]</span> = SpawnShadow<span class="br0">(</span><a href="/Pawn"><span class="kw10">Pawn</span></a><span class="br0">(</span>Other<span class="br0">)</span><span class="br0">)</span>;
<span class="br0">}</span>
 
<span class="co1">// pawns are removed from the shadow list when they untouch, and the shadow is destroyed</span>
<span class="kw5">event</span> UnTouch<span class="br0">(</span><a href="/Actor"><span class="kw10">Actor</span></a> Other<span class="br0">)</span>
<span class="br0">{</span>
        <span class="kw5">local</span> <span class="kw4">int</span> i;
 
        <span class="kw1">if</span> <span class="br0">(</span><a href="/Pawn"><span class="kw10">Pawn</span></a><span class="br0">(</span>Other<span class="br0">)</span> != <span class="kw9">None</span><span class="br0">)</span>
        <span class="br0">{</span>
                i = GetShadowIndex<span class="br0">(</span>Other<span class="br0">)</span>;
                <span class="kw1">if</span> <span class="br0">(</span>i &gt; <span class="nu0">-1</span><span class="br0">)</span>
                <span class="br0">{</span>
                        Shadows<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">Destroy</span><span class="br0">(</span><span class="br0">)</span>;
                        Shadows.<span class="kw6">Remove</span><span class="br0">(</span>i,<span class="nu0">1</span><span class="br0">)</span>;
                <span class="br0">}</span>
        <span class="br0">}</span>
<span class="br0">}</span>
 
<span class="co1">// returns the index of an actor within the shadow array</span>
<span class="kw5">function</span> <span class="kw4">int</span> GetShadowIndex<span class="br0">(</span><a href="/Actor"><span class="kw10">Actor</span></a> A<span class="br0">)</span>
<span class="br0">{</span>
        <span class="kw5">local</span> <span class="kw4">int</span> i;
 
        <span class="kw1">for</span> <span class="br0">(</span>i=<span class="nu0">0</span>;i&lt;Shadows.<span class="kw6">Length</span>;++i<span class="br0">)</span>
        <span class="br0">{</span>
                <span class="kw1">if</span> <span class="br0">(</span>Shadows<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">ShadowActor</span> == A<span class="br0">)</span>
                        <span class="kw1">return</span> i;
        <span class="br0">}</span>
        <span class="kw1">return</span> <span class="nu0">-1</span>;
<span class="br0">}</span>
 
<span class="kw1">defaultproperties</span>
<span class="br0">{</span>
        bHidden=<span class="kw9">True</span>
        ShadowDetail=SD_Medium
        ShadowEffect=SE_Normal
 
        FireFlickerMagnitude=<span class="nu0">60</span>
        FireFlickerSpeed=<span class="nu0">20</span>
        PhaseScale=<span class="nu0">0.5</span>
        MaxFOV=<span class="nu0">70</span>
        FOVScale=<span class="nu0">0.9</span>
        MaxTraceDistance=<span class="nu0">1000</span>
 
        bCollideActors=<span class="kw9">True</span>
        bUseCylinderCollision=<span class="kw9">True</span>
        CollisionHeight=<span class="nu0">500</span>
        CollisionRadius=<span class="nu0">500</span>
<span class="br0">}</span>
</pre></div>
<p>The key here is that the CollisionHeight and CollisionRadius are what effect how close to the source you have to be to recieve a shadow from it. Adjusting this radius is important to the concept. Basic projector properties can be controlled with the exposed variables, and more can be added easily, and subclasses of ShadowSource can be created which have even more functionality, if that is the method you prefer.</p>
<p>As you can see, the real magic is all in the projector class. The beauty is that the projector draws itself, from the location of the ShadowSource that owns it. This way, the overhead of sorting lights and shadow projectors is eliminated. The projector simply draws until it is destroyed.</p>
<p>The projector is listed here:</p>
<div dir="ltr" style="text-align: left;" class="highlighted-source">
<pre class="source-uscript">
<span class="kw5">class</span> DynamicShadow <span class="kw5">extends</span> ShadowProjector;
 
<span class="co1">// various shadow effects can exist here</span>
<span class="kw5">var</span> <span class="kw4">enum</span> EShadowEffect
<span class="br0">{</span>
        SE_Normal,
        SE_Fire,
<span class="br0">}</span> ShadowEffect;
 
<span class="co1">// these are set by the shadow source</span>
<span class="kw5">var</span> <span class="kw4">int</span> FireFlickerMagnitude;
<span class="kw5">var</span> <span class="kw4">int</span> FireFlickerSpeed;
<span class="kw5">var</span> <span class="kw4">int</span> MaxFOV;
<span class="kw5">var</span> <span class="kw4">float</span> PhaseScale, FOVScale;
 
<span class="co1">//hack for interpolating crouch distance over time when pawn stands up again</span>
<span class="kw5">var</span> <span class="kw4">float</span> crouchtime;
<span class="kw5">var</span> <span class="kw4">vector</span> CurrentFirePos, TargetFirePos;
<span class="kw5">var</span> array&lt;vector&gt; FirePositions;
 
<span class="co1">// This must be called by the ShadowSource to initialize the projector to start drawing</span>
<span class="kw5">function</span> InitShadow<span class="br0">(</span><span class="br0">)</span>
<span class="br0">{</span>
        <span class="kw1">if</span> <span class="br0">(</span>ShadowActor != <span class="kw9">None</span><span class="br0">)</span>
        <span class="br0">{</span>
                ShadowTexture.<span class="me1">bBlobShadow</span> = bBlobShadow;
                ShadowTexture.<span class="me1">ShadowActor</span> = ShadowActor;
                ProjTexture = ShadowTexture;
 
                <span class="kw1">if</span> <span class="br0">(</span>ProjTexture != <span class="kw9">None</span><span class="br0">)</span>
                <span class="br0">{</span>
                        <span class="co1">// UpdateShadows is time driven, to allow shadow animating</span>
                        UpdateShadows<span class="br0">(</span><span class="nu0">0.03</span><span class="br0">)</span>;  <span class="co1">// start the shadow rendering, and enable tick</span>
                        <span class="kw7">Enable</span><span class="br0">(</span><span class="st0">'Tick'</span><span class="br0">)</span>;
                <span class="br0">}</span>
                <span class="co1">// timer is used for fire effect, but could be used for others as well, so </span>
                <span class="co1">// we start it up here as well</span>
                SetTimer<span class="br0">(</span><span class="kw7">FRand</span><span class="br0">(</span><span class="br0">)</span>,<span class="kw9">true</span><span class="br0">)</span>;
        <span class="br0">}</span>
<span class="br0">}</span>
 
<span class="kw5">event</span> Destroyed<span class="br0">(</span><span class="br0">)</span>
<span class="br0">{</span>
        <span class="kw1">if</span> <span class="br0">(</span>ShadowTexture != <span class="kw9">None</span><span class="br0">)</span>
        <span class="br0">{</span>
                ShadowTexture.<span class="me1">ShadowActor</span> = <span class="kw9">None</span>;
 
                <span class="kw1">if</span> <span class="br0">(</span>!ShadowTexture.<span class="me1">Invalid</span><span class="br0">)</span>
                        <span class="kw8">Level</span>.<span class="me1">ObjectPool</span>.<span class="me1">FreeObject</span><span class="br0">(</span>ShadowTexture<span class="br0">)</span>;
 
                ShadowTexture = <span class="kw9">None</span>;
                ProjTexture = <span class="kw9">None</span>;
        <span class="br0">}</span>
 
        <span class="kw6">Super</span>.<span class="me1">Destroyed</span><span class="br0">(</span><span class="br0">)</span>;
<span class="br0">}</span>
 
<span class="kw5">event</span> <span class="kw8">Tick</span><span class="br0">(</span><span class="kw4">float</span> dt<span class="br0">)</span>
<span class="br0">{</span>
        UpdateShadows<span class="br0">(</span>dt<span class="br0">)</span>;
<span class="br0">}</span>
 
<span class="kw5">function</span> Timer<span class="br0">(</span><span class="br0">)</span>
<span class="br0">{</span>
        <span class="kw1">if</span><span class="br0">(</span>ShadowEffect == SE_Fire<span class="br0">)</span>
        <span class="br0">{</span>
                <span class="co1">// random target positions for fire flicker, and random timer rate</span>
                TargetFirePos = FirePositions<span class="br0">[</span><span class="kw7">Rand</span><span class="br0">(</span>FirePositions.<span class="kw6">Length</span><span class="br0">)</span><span class="br0">]</span> * <span class="kw7">Rand</span><span class="br0">(</span>FireFlickerMagnitude<span class="br0">)</span>;
                TimerRate = <span class="kw7">FRand</span><span class="br0">(</span><span class="br0">)</span> * PhaseScale;
        <span class="br0">}</span>
        <span class="kw1">else</span>
                bTimerLoop=<span class="kw9">False</span>;       <span class="co1">// disable timer loop for non-effect shadows</span>
 
<span class="br0">}</span>
 
<span class="co1">// we use our own update shadow function</span>
<span class="kw5">function</span> UpdateShadow<span class="br0">(</span><span class="br0">)</span>;
 
<span class="co1">// updates location, rotation, and FOV</span>
<span class="kw5">function</span> UpdateShadows<span class="br0">(</span><span class="kw4">float</span> dt<span class="br0">)</span>
<span class="br0">{</span>
        <span class="kw5">local</span> <span class="kw4">vector</span> Diff, ShadowLocation, RandVec, instloc;
        <span class="kw5">local</span> <span class="kw4">rotator</span> AdjustedRotation;
        <span class="kw5">local</span> <span class="kw4">Plane</span> BoundingSphere;
 
        DetachProjector<span class="br0">(</span><span class="kw9">True</span><span class="br0">)</span>;
 
        <span class="co1">// check to make sure we should draw, maybe this should also destroy the projector</span>
        <span class="kw1">if</span> <span class="br0">(</span>Instigator.<span class="me1">bHidden</span> || !bShadowActive || ShadowTexture == <span class="kw9">None</span> || Instigator == <span class="kw9">None</span><span class="br0">)</span>
                <span class="kw1">return</span>;
 
        instloc = Instigator.<span class="me1">Location</span>;
 
        <span class="co1">// hack for fixing shadow detaching from pawn when crouching</span>
        <span class="co1">// crouchheight based on anim time, values may vary</span>
        <span class="kw1">if</span> <span class="br0">(</span>Instigator.<span class="me1">bIsCrouched</span><span class="br0">)</span>
                crouchtime = <span class="kw7">FMin</span><span class="br0">(</span>crouchtime+dt*<span class="nu0">5</span>,<span class="nu0">0.5</span><span class="br0">)</span>;
        <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">(</span>crouchtime &gt; <span class="nu0">0.0</span><span class="br0">)</span>
                crouchtime -= dt*<span class="nu0">2</span>;
 
        instloc.<span class="me1">Z</span> -= <span class="br0">(</span>Instigator.<span class="me1">CrouchHeight*crouchtime</span><span class="br0">)</span>;
 
        <span class="kw1">if</span> <span class="br0">(</span>ShadowTexture.<span class="me1">Invalid</span><span class="br0">)</span>
        <span class="br0">{</span>
                Destroy<span class="br0">(</span><span class="br0">)</span>;
                <span class="kw1">return</span>;
        <span class="br0">}</span>
 
        <span class="kw1">if</span><span class="br0">(</span>ShadowEffect == SE_Fire<span class="br0">)</span>
        <span class="br0">{</span>
                <span class="co1">// move a bit closer to the target position</span>
                RandVec = CurrentFirePos + <span class="br0">(</span>Normal<span class="br0">(</span>TargetFirePos - CurrentFirePos<span class="br0">)</span> * <span class="br0">(</span>FireFlickerSpeed * dt<span class="br0">)</span><span class="br0">)</span>;
                <span class="co1">// if we have moved too far out of range, begin moving back to the shadow source</span>
                <span class="kw1">if</span><span class="br0">(</span> VSize<span class="br0">(</span>CurrentFirePos<span class="br0">)</span> &gt;  FireFlickerMagnitude<span class="br0">)</span>
                <span class="br0">{</span>
                        TargetFirePos = FirePositions<span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span>;       <span class="co1">// reset back to 0,0,0</span>
                        RandVec = CurrentFirePos + <span class="br0">(</span>Normal<span class="br0">(</span>TargetFirePos - CurrentFirePos<span class="br0">)</span> * <span class="br0">(</span>FireFlickerSpeed * dt<span class="br0">)</span><span class="br0">)</span>;
                <span class="br0">}</span>
                <span class="co1">// if we have already reached our target position, pick a new one</span>
                <span class="kw1">else</span> <span class="kw1">if</span><span class="br0">(</span> VSize<span class="br0">(</span>TargetFirePos - RandVec<span class="br0">)</span> &gt; VSize<span class="br0">(</span>TargetFirePos - CurrentFirePos<span class="br0">)</span> <span class="br0">)</span>
                <span class="br0">{</span>
                        TargetFirePos = FirePositions<span class="br0">[</span><span class="kw7">Rand</span><span class="br0">(</span>FirePositions.<span class="kw6">Length</span><span class="br0">)</span><span class="br0">]</span> * <span class="kw7">Rand</span><span class="br0">(</span>FireFlickerMagnitude<span class="br0">)</span>;
                        RandVec = CurrentFirePos + <span class="br0">(</span>Normal<span class="br0">(</span>TargetFirePos - CurrentFirePos<span class="br0">)</span> * <span class="br0">(</span>FireFlickerSpeed * dt<span class="br0">)</span><span class="br0">)</span>;
                <span class="br0">}</span>
 
                CurrentFirePos = RandVec;
        <span class="br0">}</span>
 
        Diff = <span class="br0">(</span> Owner.<span class="me1">Location</span> + RandVec <span class="br0">)</span> - instloc;
        LightDistance = VSize<span class="br0">(</span>Diff<span class="br0">)</span>;
        ShadowLocation = instloc + <span class="br0">(</span><span class="nu0">4</span> * Normal<span class="br0">(</span>Diff<span class="br0">)</span><span class="br0">)</span>;
        <span class="kw1">if</span> <span class="br0">(</span>VSize<span class="br0">(</span>ShadowLocation-instloc<span class="br0">)</span> &gt; LightDistance<span class="br0">)</span>
                ShadowLocation = instloc;
        SetLocation<span class="br0">(</span>ShadowLocation<span class="br0">)</span>;
 
        BoundingSphere = Instigator.<span class="me1">GetRenderBoundingSphere</span><span class="br0">(</span><span class="br0">)</span>;
        FOV = <span class="br0">(</span><span class="kw7">Atan</span><span class="br0">(</span>BoundingSphere.<span class="me1">W*</span><span class="nu0">2</span> + <span class="nu0">160</span>, LightDistance<span class="br0">)</span> * <span class="nu0">180</span>/PI<span class="br0">)</span>*FOVScale;
        SetDrawScale<span class="br0">(</span> LightDistance * <span class="kw7">tan</span><span class="br0">(</span><span class="nu0">0.5</span> * FOV * PI / <span class="nu0">180</span><span class="br0">)</span> / <span class="br0">(</span><span class="nu0">0.5</span> * ShadowTexture.<span class="me1">USize</span><span class="br0">)</span> <span class="br0">)</span>;
 
        <span class="co1">// adjust rotation to fix the FOV causing the shadow to detatch from the player</span>
        AdjustedRotation = <span class="kw4">rotator</span><span class="br0">(</span>instloc-<span class="br0">(</span>Owner.<span class="me1">Location</span> + RandVec<span class="br0">)</span><span class="br0">)</span>;
        AdjustedRotation.<span class="me1">Pitch</span> -= <span class="nu0">1408</span>*<span class="br0">(</span>FOV/MaxFOV<span class="br0">)</span>;
        SetRotation<span class="br0">(</span>AdjustedRotation<span class="br0">)</span>;
 
        LightDirection = -<span class="kw4">vector</span><span class="br0">(</span>AdjustedRotation<span class="br0">)</span>;
 
        ShadowTexture.<span class="me1">LightDirection</span> = LightDirection;
        ShadowTexture.<span class="me1">LightDistance</span> = LightDistance;
        ShadowTexture.<span class="me1">LightFOV</span> = FOV;
 
        <span class="co1">// cull more if we havent rendered this pawn in 5 seconds</span>
        <span class="kw1">if</span> <span class="br0">(</span><span class="kw8">Level</span>.<span class="me1">TimeSeconds</span> - Instigator.<span class="me1">LastRenderTime</span> &gt; <span class="nu0">5</span><span class="br0">)</span>
                CullDistance = <span class="nu0">0.25</span>*<span class="kw1">Default</span>.<span class="me1">CullDistance</span>;
        <span class="kw1">else</span>
                CullDistance = <span class="kw1">Default</span>.<span class="me1">CullDistance</span>;
 
        <span class="co1">// cull shadows much earlier if below min framerate</span>
        <span class="co1">// ..this may or may not be desired, it does get rather ugly</span>
        <span class="kw1">if</span> <span class="br0">(</span><span class="kw8">Level</span>.<span class="me1">bDropDetail</span><span class="br0">)</span>
                ShadowTexture.<span class="me1">CullDistance</span> = <span class="nu0">0.5</span>*CullDistance;
        <span class="kw1">else</span>
                ShadowTexture.<span class="me1">CullDistance</span> = CullDistance;
        ShadowTexture.<span class="me1">Dirty</span> = <span class="kw9">true</span>;
 
        AttachProjector<span class="br0">(</span><span class="br0">)</span>;
<span class="br0">}</span>
 
<span class="kw1">defaultproperties</span>
<span class="br0">{</span>
        bGradient=<span class="kw9">True</span>
        CullDistance=<span class="nu0">1800</span>.<span class="me1">f</span>
 
        <span class="co1">// directional offsets for target pos movements</span>
        <span class="co1">// 1. origin (will move back to the shadow source)</span>
        FirePositions<span class="br0">(</span><span class="nu0">0</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">0</span>,Y=<span class="nu0">0</span>,Z=<span class="nu0">0</span><span class="br0">)</span>
        <span class="co1">// 2. ordinal directions (will move along one axis)</span>
        FirePositions<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">1</span>,Y=<span class="nu0">0</span>,Z=<span class="nu0">0</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">-1</span>,Y=<span class="nu0">0</span>,Z=<span class="nu0">0</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">0</span>,Y=<span class="nu0">1</span>,Z=<span class="nu0">0</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">4</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">0</span>,Y=<span class="nu0">-1</span>,Z=<span class="nu0">0</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">5</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">0</span>,Y=<span class="nu0">0</span>,Z=<span class="nu0">1</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">6</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">0</span>,Y=<span class="nu0">0</span>,Z=<span class="nu0">-1</span><span class="br0">)</span>
        <span class="co1">// 3. diagonal on axis directions (will move on two axes)</span>
        FirePositions<span class="br0">(</span><span class="nu0">7</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">0</span>,Y=<span class="nu0">1</span>,Z=<span class="nu0">1</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">8</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">1</span>,Y=<span class="nu0">0</span>,Z=<span class="nu0">1</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">9</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">0</span>,Y=<span class="nu0">-1</span>,Z=<span class="nu0">1</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">10</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">-1</span>,Y=<span class="nu0">0</span>,Z=<span class="nu0">1</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">11</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">-1</span>,Y=<span class="nu0">0</span>,Z=<span class="nu0">-1</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">12</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">0</span>,Y=<span class="nu0">-1</span>,Z=<span class="nu0">-1</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">13</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">1</span>,Y=<span class="nu0">0</span>,Z=<span class="nu0">-1</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">14</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">0</span>,Y=<span class="nu0">-1</span>,Z=<span class="nu0">-1</span><span class="br0">)</span>
        <span class="co1">// 4. diagonal mid axis directions (will move on three axes)</span>
        FirePositions<span class="br0">(</span><span class="nu0">15</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">1</span>,Y=<span class="nu0">1</span>,Z=<span class="nu0">-1</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">16</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">1</span>,Y=<span class="nu0">-1</span>,Z=<span class="nu0">-1</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">17</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">-1</span>,Y=<span class="nu0">-1</span>,Z=<span class="nu0">-1</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">18</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">-1</span>,Y=<span class="nu0">1</span>,Z=<span class="nu0">-1</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">19</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">-1</span>,Y=<span class="nu0">1</span>,Z=<span class="nu0">1</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">20</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">1</span>,Y=<span class="nu0">1</span>,Z=<span class="nu0">1</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">21</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">1</span>,Y=<span class="nu0">-1</span>,Z=<span class="nu0">1</span><span class="br0">)</span>
        FirePositions<span class="br0">(</span><span class="nu0">22</span><span class="br0">)</span>=<span class="br0">(</span>X=<span class="nu0">-1</span>,Y=<span class="nu0">-1</span>,Z=<span class="nu0">1</span><span class="br0">)</span>
<span class="br0">}</span>
</pre></div>
<p><a name="Issues_to_consider" id="Issues_to_consider"></a></p>
<h3><span class="mw-headline">Issues to consider</span></h3>
<p>First, the code is largely untested in practical play, but does work. Issues to consider, which have not been specifically tested include:</p>
<ul>
<li><b>What happens if a pawn is spawned inside the CollisionRadius of a ShadowSource?</b>
<ul>
<li>If Touch() is called correctly, then everything works properly, but if not...</li>
</ul>
</li>
<li><b>What happens if a pawn is killed inside the CollisionRadius of a ShadowSource?</b>
<ul>
<li>Only if UnTouch() is called when the pawn dies will the shadow be destroyed</li>
</ul>
</li>
<li><b>What about other light effects?</b></li>
</ul>
<p><a name="Comments" id="Comments"></a></p>
<h3><span class="mw-headline">Comments</span></h3>
<p><b>Blueneptune:</b> It appears that the shadow projectors will clip off pieces of the shadow that are out of their FOV angle. This happens often when near a light since the projector is always so close to the shadowed actor. This solution is bad for the shadow texture sharpness, but I found that setting the projector to the light's location works much better for shadow clipping (unless the mesh being shadowed encapsulates the light). As said, it's bad for the shadow sharpness and it often needs adjustments to the rotation since it's set too low.</p>
<p><b>Bonehed316:</b> A compromise solution would be to set the projector location somewhere between the source and the pawn. Also I need to put some pics up, and get a working demo, I think. Maybe one day.</p>
<p><b>MythOpus:</b> To solve the problems of a pawn dying inside the actors collision zone, when spawning the projectors, set the owner of the projector to that of the pawn it is being created on. Then in the projector class, have it destroy itself when it's owner = none.</p>
<p><b>Foxpaw:</b> Untouch() will not get called when a pawn is destroyed, but I believe it will be called when a pawn actor is destroyed (and removed from the world). So the pawn would continue to have the projector acting on it while it was ragdolling.</p>
<p>Mythopus' solution is good but instead of using Owner I would use a variable declared in the projector and use that to store the pawn. I am wary of using Owner because Owner has some special implications when it comes to replication that I'd generally prefer not to worry about. Since the projector would be client-side, I don't THINK that you would have problems with this, but it might not hurt to store it in an internal variable instead of Owner.</p>
<p><b>Bonehed316:</b> It uses the owning pawn as its Instigator as well, so that could be checked, since it's already used. I think the Owner should be the ShadowSource (logically this is accurate, but I'm not sure about the replication implications). As far as I know though, the shadow is destroyed when the Pawn dies, but the ShadowSource's list would not be updated, which must also be solved . This could probably be solved by calling a new function on the ShadowSource from the Projector's Destroyed() function which would remove itself from the ShadowSource's array iff Instigator == None (which, correct me if I'm wrong, means the Instigator was killed).</p>
<p><b>Bonehed316:</b> Also the ShadowSource needs to destroy any projectors that exist if/when it is destroyed. The garbage collector might still get them, but I think this is important anyway.</p>

<!-- 
NewPP limit report
Preprocessor node count: 9/1000000
Post-expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
#ifexist count: 0/100
-->
<div class="printfooter">
</div>
	    	    <!-- end content -->
	    <div class="visualClear"></div>
	  </div>
	</div>
      </div>
      <div id="column-one">
	<div id="p-cactions" class="portlet">
	  <h5>Views</h5>
	  <ul>
	    <li id="ca-nstab-legacy"
	       class="selected"	       ><a href="../../../../articles/b/o/n/Legacy%7EBonehed316_ShadowSource_b88e.html">Legacy</a></li><li id="ca-talk"
	       class="new"	       ><a href="../../../../articles/b/o/n/Legacy_talk%7EBonehed316_ShadowSource_5cdd.html">Discussion</a></li><li id="ca-current"
	       	       ><a href="http://wiki.beyondunreal.com/Legacy:Bonehed316/ShadowSource">Current revision</a></li>	  </ul>
	</div>
	<div class="portlet" id="p-logo">
	  <a style="background-image: url(../../../../misc/uewiki.png);"
	    href="../../../../index.html"
	    title="Main Page"></a>
	</div>
	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
		<div class='portlet' id='p-navigation'>
	  <h5>Navigation</h5>
	  <div class='pBody'>
	    <ul>
	    	      <li id="n-mainpage"><a href="../../../../index.html">Main Page</a></li>
	     	      <li id="n-portal"><a href="../../../../articles/c/o/m/Unreal_Wiki%7ECommunity_Portal_3311.html">Community portal</a></li>
	     	      <li id="n-help"><a href="../../../../articles/c/o/n/Help%7EContents_22de.html">Help</a></li>
	     	    </ul>
	  </div>
	</div>
		<div id="p-search" class="portlet">
	  <h5><label for="searchInput">Search</label></h5>
	  <div id="searchBody" class="pBody">
	    <form action="javascript:goToStatic(3)" id="searchform"><div>
	      <input id="searchInput" name="search" type="text"
	        accesskey="f" value="" />
	      <input type='submit' name="go" class="searchButton" id="searchGoButton"
	        value="Go" />
	    </div></form>
	  </div>
	</div>
	      </div><!-- end of the left (by default at least) column -->
      <div class="visualClear"></div>
      <div id="footer">
    <div id="f-poweredbyico"><a href="http://www.mediawiki.org/"><img src="../../../../skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" /></a></div>	<div id="f-copyrightico"><a href="../../../../../COPYING.html"><img src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" alt='Attribution-Noncommercial-Share Alike 3.0' /></a></div>	<ul id="f-list">
	  	  	  <li id="f-credits">This page was last modified 05:15, 25 June 2005 by Anonymous user(s) of Unreal Wiki. </li>	  <li id="f-copyright">Licensed as <a href="../../../../articles/c/o/p/Unreal_Wiki%7ECopyrights_e561.html" title="Unreal Wiki:Copyrights">Attribution-Noncommercial-Share Alike 3.0</a>.</li>	  <li id="f-about"><a href="../../../../articles/a/b/o/Unreal_Wiki%7EAbout_9ce6.html" title="Unreal Wiki:About">About Unreal Wiki</a></li>	  <li id="f-disclaimer"><a href="../../../../articles/g/e/n/Unreal_Wiki%7EGeneral_disclaimer_a0a2.html" title="Unreal Wiki:General disclaimer">Disclaimers</a></li>	  	</ul>
      </div>
    </div>
  </body>
</html>
